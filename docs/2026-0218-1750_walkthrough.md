# v1.3.3 IME確定Enterバグ修正 — Walkthrough

## 概要

MacでGemini・Slackなどの日本語IME入力時に、漢字変換確定のEnterキーが改行として誤処理される不具合を修正。

## 根本原因

[index.ts](file:///Users/kimura512/dev/ctrlEnterSenderA/src/content/index.ts) のキーイベント処理で `event.isComposing` チェックが皆無。IME変換確定Enterが `isPlainEnter === true` と判定され `insertNewline()` が呼ばれていた。

## 変更内容

| ファイル | 変更 |
|---------|------|
| [index.ts](file:///Users/kimura512/dev/ctrlEnterSenderA/src/content/index.ts) | IME composingガード追加（2箇所） + `shouldIgnoreKeyEvent`関数の利用 |
| [keyClassifier.ts](file:///Users/kimura512/dev/ctrlEnterSenderA/src/content/keyClassifier.ts) | **[NEW]** 判定ロジックを純粋関数として抽出 |
| [keyhandler.test.ts](file:///Users/kimura512/dev/ctrlEnterSenderA/src/content/__tests__/keyhandler.test.ts) | **[NEW]** 23ケースのユニットテスト |
| [jest.config.ts](file:///Users/kimura512/dev/ctrlEnterSenderA/jest.config.ts) | **[NEW]** Jest設定 |
| [package.json](file:///Users/kimura512/dev/ctrlEnterSenderA/package.json) | v1.3.3 + testスクリプト + Jest依存追加 |
| [manifest.json](file:///Users/kimura512/dev/ctrlEnterSenderA/manifest.json) | v1.3.3 |

### 修正のキモ

```diff
 captureTarget.addEventListener('keydown', (evt) => {
     const event = evt as KeyboardEvent;
     if (!event.isTrusted) return;
+    if (shouldIgnoreKeyEvent(event)) return;  // ← これだけ！
     if (!currentConfig || !currentConfig.enabled) return;
```

`shouldIgnoreKeyEvent` は `event.isComposing || event.keyCode === 229` をチェック。`keyCode === 229` は古いブラウザ/Chrome on Mac でのフォールバック。

## テスト結果

```
Tests:       23 passed, 23 total
Time:        0.854 s
```

## ビルド結果

`pnpm build` 成功。54モジュール変換、エラーなし。

## 残作業

- [ ] **実機テスト（ユーザー実施）**: Gemini, Slack で日本語入力→漢字変換確定Enter→改行しないことを確認
- [x] コミット＆プッシュ

## Popup UI Improvements & i18n (v1.3.3+)

### Changes
1.  **Mode Toggle**: Added a toggle switch in the popup to switch between "Blacklist Mode" (Default ON) and "Whitelist Mode" (Default OFF).
2.  **UI Unification**: Refactored `Toggle` component to ensure consistent design between mode switch and site enable/disable switch.
3.  **Full i18n Support**: Updated messages for all 34 supported languages.
    -   Added proper descriptions with newlines support.
    -   Verified translations for `blacklistMode`, `whitelistMode`, and their descriptions.

### Verification Results
-   **Build**: `pnpm build` passed successfully.
-   **i18n**: Verified all 34 `messages.json` files contain the correct translated keys.
